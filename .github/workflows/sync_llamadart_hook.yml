name: Sync llamadart Hook

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to sync (e.g., b8011)'
        required: true

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout llamadart
        uses: actions/checkout@v4
        with:
          repository: leehack/llamadart
          token: ${{ secrets.LLAMADART_REPO_TOKEN }}
          path: llamadart

      - name: Update hook/build.dart
        run: |
          chmod +x scripts/update_llamadart_hook.sh
          scripts/update_llamadart_hook.sh \
            "llamadart" \
            "${{ steps.tag.outputs.tag }}" \
            "leehack/llamadart-native"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.LLAMADART_REPO_TOKEN }}
          path: llamadart
          commit-message: "chore(native): sync native release ${{ steps.tag.outputs.tag }}"
          title: "chore(native): sync native release ${{ steps.tag.outputs.tag }}"
          body: |
            Automated update from `llamadart-native` release `${{ steps.tag.outputs.tag }}`.

            - Updates `hook/build.dart` tag pin.
            - Updates native release base URL to `llamadart-native`.
          branch: "chore/native-sync-${{ steps.tag.outputs.tag }}"
          delete-branch: true
