name: Native Build & Release

on:
  workflow_dispatch:
    inputs:
      llama_cpp_tag:
        description: 'llama.cpp ref to build (e.g., b8011, latest, submodule)'
        required: true
        default: 'submodule'
      linux_backend:
        description: 'Linux backend'
        required: true
        default: 'vulkan'
        type: choice
        options: [vulkan, cpu, cuda, zendnn]
      windows_backend:
        description: 'Windows backend'
        required: true
        default: 'vulkan'
        type: choice
        options: [vulkan, cpu, cuda]
      android_backend:
        description: 'Android backend'
        required: true
        default: 'opencl'
        type: choice
        options: [opencl, vulkan, cpu]
      apple_backend:
        description: 'Apple backend'
        required: true
        default: 'metal'
        type: choice
        options: [metal, cpu]
      publish_release:
        description: 'Publish GitHub release'
        required: true
        default: true
        type: boolean

permissions:
  contents: write

env:
  CMAKE_C_COMPILER_LAUNCHER: ccache
  CMAKE_CXX_COMPILER_LAUNCHER: ccache

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Resolve llama.cpp tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"

          if [ -z "$TAG" ] || [ "$TAG" = "latest" ]; then
            TAG=$(gh api repos/ggml-org/llama.cpp/releases/latest --jq '.tag_name')
          elif [ "$TAG" = "submodule" ]; then
            TAG=$(git -C native/deps/llama.cpp describe --tags --exact-match 2>/dev/null || git -C native/deps/llama.cpp rev-parse --short HEAD)
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

  build-android:
    needs: resolve-tag
    runs-on: ubuntu-latest
    strategy:
      matrix:
        android_abi: [arm64-v8a, x86_64]
    defaults:
      run:
        working-directory: native
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C deps/llama.cpp fetch --tags --force origin
          git -C deps/llama.cpp checkout --detach "$TAG"
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Setup Android SDK/NDK
        uses: android-actions/setup-android@v3
      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache
      - name: Build
        env:
          ANDROID_GPU_BACKEND: ${{ github.event.inputs.android_backend }}
        run: ./build_android.sh ${{ matrix.android_abi }}
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_android_${{ matrix.android_abi }}
          path: native/bin/android/*/libllamadart.so

  build-apple:
    needs: resolve-tag
    runs-on: macos-latest
    strategy:
      matrix:
        target: [macos-arm64, macos-x86_64, ios-device-arm64, ios-sim-arm64, ios-sim-x86_64]
    defaults:
      run:
        working-directory: native
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C deps/llama.cpp fetch --tags --force origin
          git -C deps/llama.cpp checkout --detach "$TAG"
      - name: Install build deps
        run: brew install ccache
      - name: Build
        run: ./build_apple.sh ${{ matrix.target }} "" ${{ github.event.inputs.apple_backend }}
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_apple_${{ matrix.target }}
          path: |
            native/bin/macos/**/*.dylib
            native/bin/ios/*.dylib

  build-linux:
    needs: resolve-tag
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: [{arch: x64}, {arch: arm64}]
    defaults:
      run:
        working-directory: native
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C deps/llama.cpp fetch --tags --force origin
          git -C deps/llama.cpp checkout --detach "$TAG"
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache ninja-build
          if [ "${{ github.event.inputs.linux_backend }}" = "vulkan" ]; then
            sudo apt-get install -y libvulkan-dev glslc
          fi
          if [ "${{ matrix.config.arch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi
      - name: Build
        run: |
          backend="${{ github.event.inputs.linux_backend }}"
          arch="${{ matrix.config.arch }}"

          if [ "$backend" = "cuda" ] && [ "$arch" != "x64" ]; then
            echo "Skipping linux arm64 for cuda backend"
            exit 0
          fi
          if [ "$backend" = "zendnn" ] && [ "$arch" != "x64" ]; then
            echo "Skipping linux arm64 for zendnn backend"
            exit 0
          fi

          ./build_linux.sh "$backend" "$arch"
      - name: Upload
        if: ${{ !((github.event.inputs.linux_backend == 'cuda' || github.event.inputs.linux_backend == 'zendnn') && matrix.config.arch == 'arm64') }}
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_linux_${{ matrix.config.arch }}
          path: native/bin/linux/${{ matrix.config.arch }}/libllamadart.so

  build-windows:
    needs: resolve-tag
    runs-on: windows-latest
    defaults:
      run:
        working-directory: native
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C deps/llama.cpp fetch --tags --force origin
          git -C deps/llama.cpp checkout --detach "$TAG"
      - name: Install Ninja
        run: choco install ninja -y
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Configure sccache
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $env:GITHUB_ENV
      - name: Install Vulkan SDK
        if: ${{ github.event.inputs.windows_backend == 'vulkan' }}
        run: |
          $ver = "1.4.313.2"
          curl.exe -o $env:RUNNER_TEMP/VulkanSDK-Installer.exe -L "https://sdk.lunarg.com/sdk/download/$ver/windows/vulkansdk-windows-X64-$ver.exe"
          & "$env:RUNNER_TEMP\VulkanSDK-Installer.exe" --accept-licenses --default-answer --confirm-command install
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\$ver"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\$ver\Bin"
      - name: Build
        run: .\build_windows.ps1 ${{ github.event.inputs.windows_backend }}
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_windows_x64
          path: native/bin/windows/x64/libllamadart.dll

  package-and-release:
    needs: [resolve-tag, build-android, build-apple, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release assets
        env:
          LINUX_BACKEND: ${{ github.event.inputs.linux_backend }}
          WINDOWS_BACKEND: ${{ github.event.inputs.windows_backend }}
          ANDROID_BACKEND: ${{ github.event.inputs.android_backend }}
          APPLE_BACKEND: ${{ github.event.inputs.apple_backend }}
        run: |
          mkdir -p release_assets

          cp "$(find artifacts/libllamadart_windows_x64 -name '*.dll' | head -n 1)" \
             "release_assets/libllamadart-windows-x64-${WINDOWS_BACKEND}.dll"

          if [ -d artifacts/libllamadart_linux_x64 ]; then
            cp "$(find artifacts/libllamadart_linux_x64 -name '*.so' | head -n 1)" \
               "release_assets/libllamadart-linux-x64-${LINUX_BACKEND}.so"
          fi

          if [ -d artifacts/libllamadart_linux_arm64 ]; then
            cp "$(find artifacts/libllamadart_linux_arm64 -name '*.so' | head -n 1)" \
               "release_assets/libllamadart-linux-arm64-${LINUX_BACKEND}.so"
          fi

          cp "$(find artifacts/libllamadart_apple_macos-arm64 -name '*.dylib' | head -n 1)" \
             "release_assets/libllamadart-macos-arm64-${APPLE_BACKEND}.dylib"
          cp "$(find artifacts/libllamadart_apple_macos-x86_64 -name '*.dylib' | head -n 1)" \
             "release_assets/libllamadart-macos-x86_64-${APPLE_BACKEND}.dylib"

          cp "$(find artifacts/libllamadart_apple_ios-device-arm64 -name '*.dylib' | head -n 1)" \
             "release_assets/libllamadart-ios-arm64-${APPLE_BACKEND}.dylib"
          cp "$(find artifacts/libllamadart_apple_ios-sim-arm64 -name '*.dylib' | head -n 1)" \
             "release_assets/libllamadart-ios-arm64-sim-${APPLE_BACKEND}.dylib"
          cp "$(find artifacts/libllamadart_apple_ios-sim-x86_64 -name '*.dylib' | head -n 1)" \
             "release_assets/libllamadart-ios-x86_64-sim-${APPLE_BACKEND}.dylib"

          cp "$(find artifacts/libllamadart_android_arm64-v8a -name '*.so' | head -n 1)" \
             "release_assets/libllamadart-android-arm64-${ANDROID_BACKEND}.so"
          cp "$(find artifacts/libllamadart_android_x86_64 -name '*.so' | head -n 1)" \
             "release_assets/libllamadart-android-x64-${ANDROID_BACKEND}.so"

          ls -la release_assets

      - name: Generate manifest + checksums
        run: |
          chmod +x scripts/generate_assets_manifest.sh
          scripts/generate_assets_manifest.sh \
            "${{ needs.resolve-tag.outputs.tag }}" \
            release_assets \
            release_assets/assets.json \
            release_assets/SHA256SUMS

      - name: Create release
        if: ${{ github.event.inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          name: ${{ needs.resolve-tag.outputs.tag }}
          files: release_assets/*
          prerelease: false
