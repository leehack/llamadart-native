name: Native Build & Release

on:
  workflow_dispatch:
    inputs:
      llama_cpp_tag:
        description: 'llama.cpp ref to build (e.g., b8011, latest, submodule)'
        required: true
        default: 'submodule'
      publish_release:
        description: 'Publish GitHub release'
        required: true
        default: true
        type: boolean

permissions:
  contents: write

env:
  CMAKE_C_COMPILER_LAUNCHER: ccache
  CMAKE_CXX_COMPILER_LAUNCHER: ccache

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Resolve llama.cpp tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"

          if [ -z "$TAG" ] || [ "$TAG" = "latest" ]; then
            TAG=$(gh api repos/ggml-org/llama.cpp/releases/latest --jq '.tag_name')
          elif [ "$TAG" = "submodule" ]; then
            TAG=$(git -C third_party/llama.cpp describe --tags --exact-match 2>/dev/null || git -C third_party/llama.cpp rev-parse --short HEAD)
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

  build-android:
    needs: resolve-tag
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - android_abi: arm64-v8a
            out_arch: arm64
          - android_abi: x86_64
            out_arch: x64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C third_party/llama.cpp fetch --tags --force origin
          git -C third_party/llama.cpp checkout --detach "$TAG"
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Setup Android SDK/NDK
        uses: android-actions/setup-android@v3
      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache
      - name: Build
        run: python3 tools/build.py android --abi ${{ matrix.android_abi }}
      - name: Validate Android backend artifacts
        run: |
          OUT_DIR="bin/android/${{ matrix.out_arch }}"
          test -f "$OUT_DIR/libggml-vulkan.so" || { echo "Missing $OUT_DIR/libggml-vulkan.so"; exit 1; }
          test -f "$OUT_DIR/libggml-opencl.so" || { echo "Missing $OUT_DIR/libggml-opencl.so"; exit 1; }
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: native_android_${{ matrix.android_abi }}
          path: bin/android/${{ matrix.out_arch }}/*

  build-apple:
    needs: resolve-tag
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: macos-arm64
            out_dir: macos/arm64
          - target: macos-x86_64
            out_dir: macos/x86_64
          - target: ios-device-arm64
            out_dir: ios/arm64
          - target: ios-sim-arm64
            out_dir: ios/arm64-sim
          - target: ios-sim-x86_64
            out_dir: ios/x86_64-sim
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C third_party/llama.cpp fetch --tags --force origin
          git -C third_party/llama.cpp checkout --detach "$TAG"
      - name: Install build deps
        run: brew install ccache
      - name: Build
        run: python3 tools/build.py apple --target ${{ matrix.target }}
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: native_apple_${{ matrix.target }}
          path: bin/${{ matrix.out_dir }}/*

  build-linux:
    needs: resolve-tag
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
          - arch: arm64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C third_party/llama.cpp fetch --tags --force origin
          git -C third_party/llama.cpp checkout --detach "$TAG"
      - name: Install build deps
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo dpkg --add-architecture arm64
            source /etc/os-release
            CODENAME="${VERSION_CODENAME}"
            {
              echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${CODENAME} main universe restricted multiverse"
              echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-updates main universe restricted multiverse"
              echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-backports main universe restricted multiverse"
              echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-security main universe restricted multiverse"
            } | sudo tee /etc/apt/sources.list.d/arm64-ports.list >/dev/null
          fi
          sudo apt-get update
          sudo apt-get install -y ccache ninja-build pkg-config libvulkan-dev glslc make
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libopenblas-dev:arm64 libvulkan-dev:arm64
          else
            sudo apt-get install -y libopenblas-dev
          fi
          if [ "${{ matrix.arch }}" = "x64" ]; then
            sudo apt-get install -y nvidia-cuda-toolkit
          fi
      - name: Build
        run: python3 tools/build.py linux --arch "${{ matrix.arch }}"
      - name: Validate Linux backend artifacts
        run: |
          OUT_DIR="bin/linux/${{ matrix.arch }}"
          test -f "$OUT_DIR/libggml-vulkan.so" || { echo "Missing $OUT_DIR/libggml-vulkan.so"; exit 1; }
          find "$OUT_DIR" -maxdepth 1 -type f -name 'libggml-blas.so*' | grep -q . || { echo "Missing BLAS backend in $OUT_DIR"; exit 1; }
          if [ "${{ matrix.arch }}" = "x64" ]; then
            find "$OUT_DIR" -maxdepth 1 -type f -name 'libggml-cuda.so*' | grep -q . || { echo "Missing CUDA backend in $OUT_DIR"; exit 1; }
          fi
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: native_linux_${{ matrix.arch }}
          path: bin/linux/${{ matrix.arch }}/*

  build-windows:
    needs: resolve-tag
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            vcpkg_triplet: x64-windows
          - arch: arm64
            vcpkg_triplet: arm64-windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Enable Git Long Paths
        run: git config --global core.longpaths true
      - name: Checkout llama.cpp ref
        if: ${{ github.event.inputs.llama_cpp_tag != 'submodule' }}
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          git -C third_party/llama.cpp fetch --tags --force origin
          git -C third_party/llama.cpp checkout --detach "$TAG"
      - name: Install Ninja
        run: choco install ninja -y
      - name: Install CUDA Toolkit
        if: ${{ matrix.arch == 'x64' }}
        run: choco install cuda -y
      - name: Install OpenBLAS (vcpkg)
        run: |
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          if (-not $vcpkgRoot) { $vcpkgRoot = $env:VCPKG_ROOT }
          if (-not $vcpkgRoot -and (Test-Path "C:\vcpkg")) { $vcpkgRoot = "C:\vcpkg" }
          if (-not $vcpkgRoot) {
            $vcpkgRoot = Join-Path $env:RUNNER_TEMP "vcpkg"
            git clone https://github.com/microsoft/vcpkg "$vcpkgRoot"
          }
          if (-not (Test-Path "$vcpkgRoot\vcpkg.exe")) {
            & "$vcpkgRoot\bootstrap-vcpkg.bat" -disableMetrics
          }
          & "$vcpkgRoot\vcpkg.exe" install "openblas:${{ matrix.vcpkg_triplet }}"
          Add-Content $env:GITHUB_ENV "VCPKG_ROOT=$vcpkgRoot"
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Configure sccache
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $env:GITHUB_ENV
      - name: Install Vulkan SDK
        run: |
          $ver = "1.4.313.2"
          curl.exe -o $env:RUNNER_TEMP/VulkanSDK-Installer.exe -L "https://sdk.lunarg.com/sdk/download/$ver/windows/vulkansdk-windows-X64-$ver.exe"
          & "$env:RUNNER_TEMP\VulkanSDK-Installer.exe" --accept-licenses --default-answer --confirm-command install
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\$ver"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\$ver\Bin"
      - name: Build
        run: python tools/build.py windows --arch ${{ matrix.arch }}
      - name: Validate Windows backend artifacts
        run: |
          $out = "bin/windows/${{ matrix.arch }}"
          if (-not (Get-ChildItem $out -Filter "*ggml-vulkan*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1)) {
            throw "Missing Vulkan backend DLL in $out"
          }
          if (-not (Get-ChildItem $out -Filter "*ggml-blas*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1)) {
            throw "Missing BLAS backend DLL in $out"
          }
          if ("${{ matrix.arch }}" -eq "x64") {
            if (-not (Get-ChildItem $out -Filter "*ggml-cuda*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1)) {
              throw "Missing CUDA backend DLL in $out"
            }
          } else {
            $cache = "build/windows-arm64-full/CMakeCache.txt"
            if (-not (Test-Path $cache)) {
              throw "Missing CMake cache at $cache"
            }
            if (-not (Select-String -Path $cache -Pattern '^GGML_CPU_KLEIDIAI:BOOL=ON$' -Quiet)) {
              throw "Kleidi is not enabled in windows arm64 build"
            }
          }
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: native_windows_${{ matrix.arch }}
          path: bin/windows/${{ matrix.arch }}/*

  package-and-release:
    needs: [resolve-tag, build-android, build-apple, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          rename_with_suffix() {
            local base="$1"
            local platform="$2"
            local arch="$3"

            case "$base" in
              *.dylib)
                echo "${base%.dylib}-${platform}-${arch}.dylib"
                ;;
              *.dll)
                echo "${base%.dll}-${platform}-${arch}.dll"
                ;;
              *.so)
                echo "${base%.so}-${platform}-${arch}.so"
                ;;
              *.so.*)
                local prefix="${base%%.so*}"
                local rest="${base#${prefix}}"
                echo "${prefix}-${platform}-${arch}${rest}"
                ;;
              *)
                echo "${base}-${platform}-${arch}"
                ;;
            esac
          }

          for dir in artifacts/native_*; do
            [ -d "$dir" ] || continue
            name="$(basename "$dir")"

            platform=""
            arch=""
            case "$name" in
              native_windows_x64)
                platform="windows"; arch="x64" ;;
              native_windows_arm64)
                platform="windows"; arch="arm64" ;;
              native_linux_x64)
                platform="linux"; arch="x64" ;;
              native_linux_arm64)
                platform="linux"; arch="arm64" ;;
              native_apple_macos-arm64)
                platform="macos"; arch="arm64" ;;
              native_apple_macos-x86_64)
                platform="macos"; arch="x86_64" ;;
              native_apple_ios-device-arm64)
                platform="ios"; arch="arm64" ;;
              native_apple_ios-sim-arm64)
                platform="ios"; arch="arm64-sim" ;;
              native_apple_ios-sim-x86_64)
                platform="ios"; arch="x86_64-sim" ;;
              native_android_arm64-v8a)
                platform="android"; arch="arm64" ;;
              native_android_x86_64)
                platform="android"; arch="x64" ;;
              *)
                echo "Skipping unknown artifact directory: $name"
                continue
                ;;
            esac

            while IFS= read -r src; do
              [ -n "$src" ] || continue
              base="$(basename "$src")"
              dst="$(rename_with_suffix "$base" "$platform" "$arch")"
              cp "$src" "release_assets/$dst"
            done < <(find "$dir" -maxdepth 1 -type f \( -name '*.dll' -o -name '*.dylib' -o -name '*.so' -o -name '*.so.*' \) | sort)
          done

          ls -la release_assets
          test -n "$(find release_assets -maxdepth 1 -type f -print -quit)"

      - name: Generate manifest + checksums
        run: |
          chmod +x scripts/generate_assets_manifest.sh
          scripts/generate_assets_manifest.sh \
            "${{ needs.resolve-tag.outputs.tag }}" \
            release_assets \
            release_assets/assets.json \
            release_assets/SHA256SUMS

      - name: Create release
        if: ${{ github.event.inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          name: ${{ needs.resolve-tag.outputs.tag }}
          files: release_assets/*
          prerelease: false
